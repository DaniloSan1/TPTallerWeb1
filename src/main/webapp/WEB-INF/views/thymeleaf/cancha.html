<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Detalle de Cancha</title>

    <link
      rel="stylesheet"
      th:href="@{/webjars/bootstrap/5.2.0/css/bootstrap.min.css}"
    />
    <link rel="stylesheet" th:href="@{/css/main.css}" />
    <link rel="stylesheet" th:href="@{/css/detalle-partido.css}" />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=location_on,schedule,paid"
    />
  </head>

  <body>
    <!-- Navbar -->
    <div th:replace="~{fragments/navbar :: navbar}"></div>

    <main role="main" class="container" style="padding-top: 135px">
      <!-- Mensajes de error o éxito -->
      <div
        th:if="${error != null && cancha == null}"
        class="alert alert-danger text-center"
        id="alertError"
      >
        <h4 th:text="${error}">La cancha solicitada no existe.</h4>
      </div>
      <div
        th:if="${success != null}"
        id="alertSuccess"
        class="alert alert-success text-center"
        th:text="${success}"
      ></div>
      <!-- Mensaje de error cuando la cancha existe (por ejemplo: ya reseñó esta cancha) -->
      <div
        th:if="${error != null and cancha != null}"
        class="alert alert-danger text-center"
        id="alertErrorCancha"
      >
        <h4 th:text="${error}"></h4>
      </div>

      <!-- Contenido principal -->
      <div
        th:if="${cancha != null}"
        class="container d-flex flex-column justify-content-center width-100"
      >
        <!-- Título -->
        <div class="mainbox width-100" style="margin-top: 50px">
          <div class="d-flex flex-column align-items-center mb-4">
            <h1
              class="w-100 mb-2 text-center"
              th:text="${cancha.nombre}"
              style="margin: 0 !important"
            ></h1>
            <h3 class="w-100 text-center text-secondary" style="margin: 0 !important">
              Calificación promedio:
              <span th:text="${calificacionPromedio != null and calificacionPromedio != 0.0 ? calificacionPromedio : 'Sin calificaciones'}"></span>
            </h4>
            <h4
              id="direccion-cancha"
              class="w-100 d-flex align-items-center justify-content-center gap-2"
            >
              <span class="material-symbols-outlined"></span>
              <span th:text="${cancha.direccion}"></span>
            </h4>
            
          </div>
          <hr class="colorgraph" />
        </div>

        <!-- Mapa + Detalles -->
        <div
          id="contendor-mapa-detalle"
          class="d-flex flex-row flex-wrap align-items-center justify-content-center"
        >
          <iframe
            id="map-iframe"
            frameborder="0"
            allowfullscreen
            th:if="${cancha != null}"
            th:src="'https://www.google.com/maps/embed/v1/place?key=AIzaSyCB2Jsk_wlMEsQ5phtgegFGXuNTlHB7YNY&q=' + ${#strings.replace(cancha.direccion, ' ', '+')}"
          ></iframe>

          <div id="contenedor-detalle">
            <div id="contenedor-detalle-info">
              <div class="w-100 mb-2">
                <strong>Zona:</strong>
                <span th:text="${cancha.zona}"></span>
              </div>

              <div class="detalle-columna">
                <div class="w-100">
                  <strong>Tipo de suelo:</strong>
                  <span th:text="${cancha.tipoSuelo}"></span>
                </div>
                <div class="w-100">
                  <strong>Capacidad:</strong>
                  <span th:text="${cancha.capacidad}"></span>
                </div>
              </div>

              <div class="w-100 mt-2">
                <strong>
                  <span class="material-symbols-outlined align-middle"
                    ></span
                  >
                  Precio por hora:
                </strong>
                <span th:text="${cancha.precio}"></span>
              </div>
            </div>

            <div
              id="contenedor-detalle-acciones"
              class="d-flex flex-column justify-content-center align-items-center mt-4 gap-1"
            >
              <a
                th:href="@{/canchas-disponibles}"
                class="btn btn-primary w-100"
              >
                Volver a la lista de canchas
              </a>
               <a
                th:href="@{/reseniar-cancha/{canchaId}(canchaId=${cancha.id})}"
                class="btn btn-success w-100"
              >
                Reseñar cancha
              </a>
            </div>
          </div>
        </div>

        <!-- Reseñas: carrusel simple que muestra una reseña a la vez -->
        <div id="contenedor-resenias" class="mt-4 w-100">
          <h2 class="participantes-titulo">Reseñas</h2>
          <hr class="colorgraph" />

          <div th:if="${#lists.isEmpty(resenias)}" class="text-muted">No hay reseñas aún.</div>

            <div th:if="${!#lists.isEmpty(resenias)}" class="d-flex align-items-center justify-content-center">
            <button id="prevReview" class="btn btn-outline-secondary me-2" onclick="prevReview()">&laquo;</button>

            <div id="reviewsContainer" style="max-width:720px; width:100%">
              <div th:each="resenia, stat : ${resenias}" class="review-item card p-3 mb-2" th:attr="data-index=${stat.index}" style="display:none">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <strong th:text="${resenia.usuario != null ? (resenia.usuario.nombre != null ? resenia.usuario.nombre : resenia.usuario.username) : 'Anónimo'}">Usuario</strong>
                  <span class="badge bg-primary rating-badge" th:attr="data-rating=${resenia.calificacion}" aria-label="Calificación de la reseña">5</span>
                </div>
                <p th:text="${resenia.comentario != null && resenia.comentario != '' ? resenia.comentario : 'Sin comentario'}">Comentario</p>
                <div class="text-end text-muted" style="font-size:0.9rem">#<span th:text="${stat.index + 1}"></span> de <span th:text="${#lists.size(resenias)}"></span></div>
              </div>
            </div>

            <button id="nextReview" class="btn btn-outline-secondary ms-2" onclick="nextReview()">&raquo;</button>
          </div>
        </div>

        <!-- Listado de horarios -->
        <div id="contenedor-participantes" class="mt-5">
          <h2 class="participantes-titulo">Horarios disponibles</h2>
          <hr class="colorgraph" />

          <div th:if="${#lists.isEmpty(horarios)}" class="text-muted">
            No hay horarios disponibles.
          </div>

          <ul
            class="list-group"
            th:if="${!#lists.isEmpty(horarios)}"
          >
            <li
              class="list-group-item d-flex justify-content-between align-items-center"
              th:each="horario : ${horarios}"
            >
              <div>
                <strong th:switch="${horario.diaSemana}">
                <span th:case="${T(java.time.DayOfWeek).MONDAY}">Lunes</span>
                <span th:case="${T(java.time.DayOfWeek).TUESDAY}">Martes</span>
                <span th:case="${T(java.time.DayOfWeek).WEDNESDAY}">Miércoles</span>
                <span th:case="${T(java.time.DayOfWeek).THURSDAY}">Jueves</span>
                <span th:case="${T(java.time.DayOfWeek).FRIDAY}">Viernes</span>
                <span th:case="${T(java.time.DayOfWeek).SATURDAY}">Sábado</span>
                <span th:case="${T(java.time.DayOfWeek).SUNDAY}">Domingo</span>
                <span th:case="*">Desconocido</span>
              </strong>
                <span th:text="${horario.horaInicio}"></span> -
                <span th:text="${horario.horaFin}"></span>
              </div>
              <div>
                <button
                  th:if="${horario.disponible}"
                  class="btn btn-success btn-sm"
                  th:onclick="'location.href=\'/spring/reserva/nueva?usuarioId=' + ${usuarioId} + '&horarioId=' + ${horario.id} + '\';'"
                >
                  Reservar
                </button>
                <button
                  th:if="${!horario.disponible}"
                  class="btn btn-secondary btn-sm"
                  disabled
                >
                  No disponible
                </button>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </main>

    <script
      type="text/javascript"
      th:src="@{/webjars/bootstrap/5.2.0/js/bootstrap.min.js}"
    ></script>
    <script type="module" th:src="@{/js/common.js}"></script>
    <script>
      // Carrusel simple de reseñas
      let reviewIndex = 0;
    
      function renderStars() {
        const starEntity = '&#9733;'; 
        const emptyEntity = '&#9734;';
        const ratingElems = document.querySelectorAll('[data-rating]');
        ratingElems.forEach(elem => {
          const val = parseFloat(elem.getAttribute('data-rating'));
          if (isNaN(val) || val === 0) {
            elem.style.color='gold';
            elem.innerText = 'Sin calificaciones';
            return;
          }
          const rounded = Math.round(val);
          let starsHtml = '';
          for (let i = 0; i < 5; i++) {
            starsHtml += (i < rounded) ? starEntity : emptyEntity;
          }
          elem.innerHTML = starsHtml + ' (' + rounded + ')';
          elem.style.color = 'gold';
          elem.style.fontSize = '1.2rem';
        });
        // elementos específicos con clase rating-badge: mostrar solo estrellas sin número
        const badgeElems = document.querySelectorAll('.rating-badge');
        badgeElems.forEach(b => {
          const v = parseFloat(b.getAttribute('data-rating'));
          if (isNaN(v) || v === 0) {
            b.innerText = 'Sin';
            return;
          }
          const r = Math.round(v);
          let s = '';
          for (let i = 0; i < r; i++) s += starEntity;
          for (let i = r; i < 5; i++) s += emptyEntity;
          b.innerHTML = s;
          b.style.backgroundColor = '#0d6efd';
          b.style.color = 'gold';
        });
      }
      function showReview(i) {
        const items = document.querySelectorAll('.review-item');
        if (!items || items.length === 0) return;
        if (i < 0) i = 0;
        if (i > items.length - 1) i = items.length - 1;
        reviewIndex = i;
        items.forEach((it, idx) => {
          it.style.display = idx === i ? 'block' : 'none';
        });
        // deshabilitar botones si corresponde
        const prev = document.getElementById('prevReview');
        const next = document.getElementById('nextReview');
        if (prev) prev.disabled = (i === 0);
        if (next) next.disabled = (i === items.length - 1);
      }
      function nextReview() { showReview(reviewIndex + 1); }
      function prevReview() { showReview(reviewIndex - 1); }
      // Inicializar al cargar
      document.addEventListener('DOMContentLoaded', function() {
        const items = document.querySelectorAll('.review-item');
        renderStars();
        if (items && items.length > 0) {
          showReview(0);
        }
      });
    </script>
  </body>
</html>